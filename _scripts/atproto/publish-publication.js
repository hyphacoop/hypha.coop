#!/usr/bin/env node
/**
 * Publish a site.standard.publication record to AT Protocol
 * 
 * Usage:
 *   node publish-publication.js [--dry-run]
 *
 * 
 * Environment variables:
 *   ATPROTO_HANDLE   - Handle for the account (e.g., hypha.coop)
 *   ATPROTO_PASSWORD - App password for authentication
 *   ATPROTO_PDS_URL  - PDS URL (optional, defaults to https://bsky.social)
 */

import { AtpAgent } from '@atproto/api';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const REPO_ROOT = path.join(__dirname, '../..');
const DATA_DIR = path.join(REPO_ROOT, '_data');
const ATPROTO_DATA_FILE = path.join(DATA_DIR, 'atproto_publication.yml');
const WELL_KNOWN_FILE = path.join(REPO_ROOT, '.well-known', 'site.standard.publication');

/**
 * Generate a timestamp-based record key
 * Format: base32-encoded timestamp + random suffix
 */
function generateRecordKey() {
  const timestamp = Date.now();
  const random = Math.random().toString(36).substring(2, 8);
  return `${timestamp.toString(36)}${random}`;
}

// Publication metadata
const PUBLICATION = {
  url: 'https://hypha.coop',
  name: 'Hypha Dripline',
  description: 'Collective writing from Hypha Worker Co-operative ranging from short posts, to interviews, design retrospectives, and essays.',
};

async function main() {
  const dryRun = process.argv.includes('--dry-run');

  const handle = process.env.ATPROTO_HANDLE;
  const password = process.env.ATPROTO_PASSWORD;
  const pdsUrl = process.env.ATPROTO_PDS_URL || 'https://bsky.social';

  if (dryRun) {
    console.log(`Publishing publication record for ${PUBLICATION.name}...`);
    console.log(`PDS: ${pdsUrl}`);
    console.log(`Handle: ${handle || '(not set)'}`);
    console.log('\n--- DRY RUN MODE ---\n');
    console.log('Would create record:');
    console.log(JSON.stringify({
      $type: 'site.standard.publication',
      ...PUBLICATION
    }, null, 2));
    console.log('\nWould save to:', ATPROTO_DATA_FILE);
    console.log('Would update:', WELL_KNOWN_FILE);
    return;
  }

  if (!handle || !password) {
    console.error('Error: ATPROTO_HANDLE and ATPROTO_PASSWORD environment variables are required');
    process.exit(1);
  }

  console.log(`Publishing publication record for ${PUBLICATION.name}...`);
  console.log(`PDS: ${pdsUrl}`);
  console.log(`Handle: ${handle}`);

  // Create agent and login
  const agent = new AtpAgent({ service: pdsUrl });

  try {
    await agent.login({ identifier: handle, password });
    console.log('Logged in successfully');
  } catch (err) {
    console.error('Login failed:', err.message);
    process.exit(1);
  }

  // Generate a record key
  const rkey = generateRecordKey();

  // Create the publication record
  const record = {
    $type: 'site.standard.publication',
    ...PUBLICATION
  };

  try {
    const response = await agent.api.com.atproto.repo.createRecord({
      repo: agent.session.did,
      collection: 'site.standard.publication',
      rkey,
      record,
    });

    console.log('\nPublication record created successfully!');
    console.log('URI:', response.data.uri);
    console.log('CID:', response.data.cid);

    // Save the publication info for reference
    const publicationData = `# AT Protocol Publication Record
# Generated: ${new Date().toISOString()}
did: "${agent.session.did}"
rkey: "${rkey}"
uri: "${response.data.uri}"
cid: "${response.data.cid}"
`;

    fs.mkdirSync(DATA_DIR, { recursive: true });
    fs.writeFileSync(ATPROTO_DATA_FILE, publicationData);
    console.log(`\nPublication data saved to ${ATPROTO_DATA_FILE}`);

    // Update .well-known/site.standard.publication with the AT-URI
    const wellKnownContent = `# AT Protocol Publication Record
# Auto-generated by publish-publication.js - do not edit manually
# See _data/atproto_publication.yml for full record details

${response.data.uri}
`;
    fs.mkdirSync(path.dirname(WELL_KNOWN_FILE), { recursive: true });
    fs.writeFileSync(WELL_KNOWN_FILE, wellKnownContent);
    console.log(`Updated ${WELL_KNOWN_FILE}`);

  } catch (err) {
    console.error('Failed to create record:', err.message);
    if (err.error) console.error('Error details:', err.error);
    process.exit(1);
  }
}

main();
